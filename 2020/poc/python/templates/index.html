<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Application</title>
        <link rel="icon" href="{{ url_for('static', filename='images/node/favicon.ico') }}">
        <link href="{{ url_for('static', filename='css/vendor/bootstrap.min.css') }}" rel="stylesheet">
    </head>
    <body>
        <nav class="navbar navbar-dark bg-dark flex-md-nowrap p-0 shadow">
            <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">Application</a>
            <ul class="navbar-nav px-3">
                <li class="nav-item text-nowrap">
                    <a class="nav-link" href="#">10:00 AM</a>
                </li>
            </ul>
        </nav>
        <br>
        <main role="main" class="container">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" id="id_m_main_gateway" href="#" onclick="">Gateway</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="id_m_main_sensors" href="#" onclick="">Sensors</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="id_m_main_settings" href="#">Settings</a>
                        </li>
                    </ul>
                </div>
            </nav>
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"></div>
            <footer class="footer"></footer>
        </main>

        <!-- Icons -->
        <script src="{{ url_for('static', filename='js/vendor/feather.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/vendor/jquery-3.3.1.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/vendor/bootstrap.min.js') }}"></script>
        <script src="{{ url_for('static', filename='lib/umks/MKSApi.js') }}"></script>

        <script type="text/javascript">
            var myVar       = "{{ data }}";
            var decodedJSON = $('<div/>').html(myVar).text();
            var web_data    = $.parseJSON(decodedJSON);

            var ip    = web_data.ip;
            var port  = web_data.port;
            console.log(web_data);

            function Piterm(api) {
                var self = this;
                this.API = api;

                return this;
            }
            Piterm.prototype.GetGatwayInfo = function() {
                this.API.SendCustomCommand("gateway_info", {
                    "async": true
                }, null);
            }
            Piterm.prototype.GetSerialList = function() {
                this.API.SendCustomCommand("serial_list", {
                    "async": true
                }, null);
            }
            Piterm.prototype.Connect = function(port, baudrate) {
                this.API.SendCustomCommand("connect", {
                    "async": true,
                    "port": port,
                    "baudrate": baudrate
                }, null);
            }
            Piterm.prototype.Disconnect = function(port, baudrate) {
                this.API.SendCustomCommand("disconnect", {
                    "async": true,
                    "port": port
                }, null);
            }
            Piterm.prototype.SetWorkingPort = function(port) {
                this.API.SendCustomCommand("setworkingport", {
                    "async": true,
                    "port": port
                }, null);
            }
            Piterm.prototype.ListNodes = function() {
                this.API.SendCustomCommand("listnodes", {
                    "async": true
                }, null);
            }
            Piterm.prototype.GetNodeInfoRemote = function(node_id) {
                this.API.SendCustomCommand("getnodeinfo_r", {
                    "async": true,
                    "node_id": node_id
                }, null);
            }
            Piterm.prototype.GetSensorDataRemote = function(node_id, sensor_index) {
                this.API.SendCustomCommand("getnodedata_r", {
                    "async": true,
                    "node_id": node_id,
                    "sensor_index": sensor_index
                }, null);
            }
            Piterm.prototype.SetSensorDataRemote = function(node_id, sensor_index, sensor_value) {
                this.API.SendCustomCommand("setnodedata_r", {
                    "async": true,
                    "node_id": node_id,
                    "sensor_index": sensor_index,
                    "sensor_value": sensor_value
                }, null);
            }

            function Pidaptor(api) {
                var self = this;
                this.API = api;

                return this;
            }
            Pidaptor.prototype.GetGatwayInfo = function(callback) {
                this.API.SendCustomCommand("gateway_info", {
                    "async": false
                }, function(data, error) {
                    callback(data, error);
                });
            }
            Pidaptor.prototype.GetSerialList = function(callback) {
                this.API.SendCustomCommand("serial_list", {
                    "async": false
                }, function(data, error) {
                    callback(data, error);
                });
            }
            Pidaptor.prototype.Connect = function(port, baudrate) {
                this.API.SendCustomCommand("connect", {
                    "async": true,
                    "port": port,
                    "baudrate": baudrate
                }, function(data, error) {
                    callback(data, error);
                });
            }
            Pidaptor.prototype.Disconnect = function(port, baudrate) {
                this.API.SendCustomCommand("disconnect", {
                    "async": true,
                    "port": port
                }, function(data, error) {
                    callback(data, error);
                });
            }
            Pidaptor.prototype.SetWorkingPort = function(port) {
                this.API.SendCustomCommand("setworkingport", {
                    "async": true,
                    "port": port
                }, function(data, error) {
                    callback(data, error);
                });
            }
            Pidaptor.prototype.ListNodes = function() {
                this.API.SendCustomCommand("listnodes", {
                    "async": true
                }, function(data, error) {
                    callback(data, error);
                });
            }
            Pidaptor.prototype.GetNodeInfoRemote = function(node_id) {
                this.API.SendCustomCommand("getnodeinfo_r", {
                    "async": true,
                    "node_id": node_id
                }, function(data, error) {
                    callback(data, error);
                });
            }
            Pidaptor.prototype.GetSensorDataRemote = function(node_id, sensor_index) {
                this.API.SendCustomCommand("getnodedata_r", {
                    "async": true,
                    "node_id": node_id,
                    "sensor_index": sensor_index
                }, function(data, error) {
                    callback(data, error);
                });
            }
            Pidaptor.prototype.SetSensorDataRemote = function(node_id, sensor_index, sensor_value) {
                this.API.SendCustomCommand("setnodedata_r", {
                    "async": true,
                    "node_id": node_id,
                    "sensor_index": sensor_index,
                    "sensor_value": sensor_value
                }, function(data, error) {
                    callback(data, error);
                });
            }

            function Application() {
                var self = this;
                // Get makesense api instanse.
                this.API = MkSAPIBuilder.GetInstance();
                // Default handler
                this.API.OnUnexpectedDataArrived = function (packet) {
                    console.log(packet);
                }
                this.API.ModulesLoadedCallback = function () {
                    self.NodeLoaded();
                }
                this.EventMapper = {};
                this.Adaptor = new Pidaptor(this.API);
                this.Terminal = new Piterm(this.API);

                return this;
            }
            Application.prototype.RegisterEventHandler = function(name, callback, scope) {
                this.EventMapper[name] = { 
                    callback: callback,
                    scope: scope
                };
            }
            Application.prototype.UnregisterEventHandler = function(name) {
                delete this.EventMapper[name];
            }
            Application.prototype.Publish = function(name, data) {
                var handler  = this.EventMapper[name];
                if (handler !== undefined && handler !== null) {
                    handler.callback(data, handler.scope);
                }
            }
            Application.prototype.Connect = function(ip, port, callback) {
                var self = this;
                console.log("Connect Application");
                // Python will emit messages
                self.API.OnNodeChangeCallback = self.OnChangeEvent.bind(self);
                this.API.ConnectLocalWS(ip, port, function() {
                    console.log("Connected to local websocket");
                    callback();
                });
            }
            Application.prototype.NodeLoaded = function () {
            }
            Application.prototype.OnChangeEvent = function(packet) {
                var event = packet.payload.event;
                var data = packet.payload.data;
                this.Publish(event, data);
                console.log(packet.payload);
            }
            // ASYNC REGISTERED HANDLERS
            Application.prototype.ListHandler = function(data, scope) {
                console.log(data);
            }
            Application.prototype.GetNodeListHandler = function(data, scope) {
                var nodes = data.list;
                for (key in nodes) {
                    console.log(nodes[key]);
                }
            }
            Application.prototype.GetRemoteNodeInfoHandler = function(data, scope) {
                console.log(data);
            }
            Application.prototype.GetRemoteNodeDataHandler = function(data, scope) {
                console.log(data);
            }
            Application.prototype.SetRemoteNodeDataHandler = function(data, scope) {
                console.log(data);
            }

            var app = new Application();
            app.RegisterEventHandler("ListHandler", app.ListHandler, app);
            app.RegisterEventHandler("GetNodeListHandler", app.GetNodeListHandler, app);
            app.RegisterEventHandler("GetRemoteNodeInfoHandler", app.GetRemoteNodeInfoHandler, app);
            app.RegisterEventHandler("GetRemoteNodeDataHandler", app.GetRemoteNodeDataHandler, app);
            app.RegisterEventHandler("SetRemoteNodeDataHandler", app.SetRemoteNodeDataHandler, app);
            app.Connect(ip, port, function() {
                app.Adaptor.GetGatwayInfo(function(data, error) {
                    console.log(data);
                });
                app.Adaptor.GetSerialList(function(data, error) {
                    console.log(data);
                });
            });

            feather.replace();
            window.resizeTo(1200,800);
        </script>
    </body>
</html>