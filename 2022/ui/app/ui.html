<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>TDD Executor</title>

		[CSS]

        <link rel="stylesheet" href="/static/lib/bootstrap/css/bootstrap.min.css" crossorigin="anonymous">
		<link rel="stylesheet" href="/static/lib/bootstrap/css/docs.min.css">
     
        <style>
            body {
              font-size: .875rem;
            }
            .feather {
              width: 16px;
              height: 16px;
              vertical-align: text-bottom;
            }
            html {
              position: relative;
              min-height: 100%;
            }
            body {
              /* Margin bottom by footer height */
              margin-bottom: 60px;
            }
            .footer {
              position: absolute;
              bottom: 0;
              width: 100%;
              /* Set the fixed height of the footer here */
              height: 60px;
              line-height: 60px; /* Vertically center the text there */
              background-color: #f5f5f5;
            }
            body > .container {
              padding: 60px 15px 0;
            }
            .footer > .container {
              padding-right: 15px;
              padding-left: 15px;
            }
            code {
              font-size: 80%;
            }
        </style>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
        <main role="main" class="container">
			<br>
			<br>
			<nav class="navbar navbar-expand-lg navbar-light bg-light">
				<a class="navbar-brand" href="#">
					<img id="navbar_icon" data-obj="mks" width="30" height="30" src="resource/img/main_icon.jpg" class="d-inline-block align-top" alt="" />
					Stock Monitor
				</a>
				<div class="collapse navbar-collapse">
					<ul class="navbar-nav">
						<li class="nav-item">
							<a class="nav-link active" id="id_m_main_dashboard" href="#" onclick="ui.ViewDashboard();">Dashboard</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" id="id_m_main_stocks" href="#" onclick="ui.OpenModalAppendNewStock();">Stocks</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" id="id_m_main_portfolio" href="#" onclick="ui.OpenModalPortfolio();">Portfolios</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" id="id_m_main_import" href="#" onclick="ui.OpenModalImportStocks();">Import</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" id="id_m_main_export" href="#">Export</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" id="id_m_main_settings" href="#">Settings</a>
						</li>
					</ul>
				</div>
			</nav>
			<div>
				<hr>
				<div class="row">
					<div class="col-xl-12">
						<div class="row">
							<div class="col-xl-2 text-center">
								<span style="cursor: pointer;">Nasdaq</span>
							</div>
							<div class="col-xl-2 text-center">
								<span style="cursor: pointer;">S&P 500</span>
							</div>
							<div class="col-xl-2 text-center">
								<span style="cursor: pointer;">Gold</span>
							</div>
							<div class="col-xl-2 text-center">
								<span style="cursor: pointer;">Cruid Oil</span>
							</div>
							<div class="col-xl-2 text-center">
								<span style="cursor: pointer;">CMC Crypto 200</span>
							</div>
							<div class="col-xl-2 text-center">
								<span style="cursor: pointer;">USD/ILS</span>
							</div>
						</div>
					</div>
				</div>
				<hr>
			</div>
			<div>
				<br>
				<div id="id_application_view_module"></div>
			</div>
		</main>

		<script src="/static/lib/nodes/js/jquery_3_3_1/jquery.min.js"></script>
		<script src="/static/lib/nodes/js/popper_1_14_7/popper.min.js" crossorigin="anonymous"></script>
		<script src="/static/lib/bootstrap/js/bootstrap.min.js" crossorigin="anonymous"></script>
		<script src="/static/lib/bootstrap/js/bootstrap-slider.js" crossorigin="anonymous"></script>
		<script src="/static/lib/nodes/js/feather_4_19/feather.min.js"></script>
		<script src="/static/lib/nodes/map/feather_4_19/feather.min.js.map"></script>
		<script src="/static/lib/chartjs/current/Chart.min.js"></script>
		<script src="/mksdk-js/widgets/basic_modal.js"></script>
		<script src="/mksdk-js/widgets/basic_uploader.js"></script>
		<script src="/mksdk-js/widgets/basic_table.js"></script>
		<script src="/mksdk-js/widgets/progress_bar.js"></script>
		<script src="/mksdk-js/widgets/block_table.js"></script>
		<script src="/mksdk-js/widgets/basic_graph.js"></script>
        
        [SCRIPTS]

        <script>
			/*
			[GATEWAY]
			[NODE_UUID]
			[CUSTOM_VARS]
			*/

			[CONFIGURATION]

			console.log("Gateway IP address - " + GatewayIP);

			// User Code #1 - Start
			require ModuleStocksAdaptor
			require ModuleDashboardView
			require ModuleStockLine
			require ModuleStockInfo
			require ModuleStockHistoryGraph
			require ModuleStockDetails
			require ModulePortfolioView
			require ModuleAction
			require ModuleStockAppend
			require ModuleImportActions
			require ModulePortfolioSelectorView
			// User Code #1 - End

			$(document).ready(function() {
				// User Code #1 - Start
				
				// User Code #1 - End
			});
			
			function StockMarket(api) {
				this.Stocks 		= {};
				this.MarketStatus 	= null;
				this.UpdateInterval	= 10000;
				this.DoWork 		= false;

				this.Callbacks 		= [];

				return this;
			}

			StockMarket.prototype.GetStocks = function() {
				var self = this;

				node.API.SendCustomCommand(NodeUUID, "get_market_stocks", {
				}, function(res) {
					var payload = res.data.payload;
					this.MarketStatus = payload.status;
					if (payload.status.local_stock_market_ready == false) {
						if (self.DoWork === true) {
							setTimeout(self.GetStocks.bind(self), 2500);
						}
						return;
					}
					if (self.DoWork === true) {
						setTimeout(self.GetStocks.bind(self), self.UpdateInterval);
					}
				});
			}

			StockMarket.prototype.Start = function() {
				console.log("StockMarket Start");
				this.DoWork = true;
				this.GetStocks();
			}

			StockMarket.prototype.Stop = function() {
				console.log("StockMarket Stop");
				this.DoWork = false;
			}

			StockMarket.prototype.Update = function() {
				this.GetStocks();
			}

			StockMarket.prototype.Publish = function(data) {
				for (key in data) {
					var stock = data[key];
					this.Stocks[stock.ticker] = stock;
				}

				for (key in this.Callbacks) {
					var handler  = this.Callbacks[key];
					handler.callback(data, handler.scope);
				}
			}

			StockMarket.prototype.DeleteStock = function(ticker) {
				delete this.Stocks[ticker];
			}

			StockMarket.prototype.Register = function(id, callback, scope) {
				this.Callbacks[id] = { 
					callback: callback,
					id: id,
					scope: scope
				};
			}

			StockMarket.prototype.Unregister = function(id) {
				delete self.Callbacks[id];
			}

			function NodeUI(api) {
				this.API = api;
				window.Modal = new MksBasicModal("GLOBAL");

				return this;
			}

			NodeUI.prototype.CleanActiveNavigation = function() {
				document.getElementById("id_m_main_dashboard").classList.remove("active");
				document.getElementById("id_m_main_stocks").classList.remove("active");
				document.getElementById("id_m_main_portfolio").classList.remove("active");
				document.getElementById("id_m_main_import").classList.remove("active");
				document.getElementById("id_m_main_export").classList.remove("active");
				document.getElementById("id_m_main_settings").classList.remove("active");
			}

			NodeUI.prototype.ViewDashboard = function() {
				window.DashboardView.Build(null, function(module) {
				});
				this.CleanActiveNavigation();
				document.getElementById("id_m_main_dashboard").classList.add("active");
			}

			NodeUI.prototype.OpenModalAppendNewStock = function() {
				window.StockAppend.Build(null, function(module) {
					window.StockAppend.GetDataBaseStocks();
					window.StockAppend.GetPortfolioList();
				});
				this.CleanActiveNavigation();
				document.getElementById("id_m_main_stocks").classList.add("active");
			}

			NodeUI.prototype.OpenModalPortfolio = function() {
				window.Portfolio.Build(null, function(module) {
					window.Portfolio.UpdatePortfolioList()
				});
				this.CleanActiveNavigation();
				document.getElementById("id_m_main_portfolio").classList.add("active");
			}

			NodeUI.prototype.OpenModalImportStocks = function() {
				window.ImportActions.Build(null, function(module) {
					module.BuildUploader();
				});
				this.CleanActiveNavigation();
				document.getElementById("id_m_main_import").classList.add("active");
			}

			var UserInit = function() {
				// User Code #1 - Start

				// User Code #1 - End
			}

			var UserPostInit = function() {
				// User Code #1 - Start

				// User Code #1 - End
			}

			var UserNodeLoaded = function() {
				// User Code #1 - Start
				window.DashboardView = new ModuleDashboardView();
				window.DashboardView.SetHostingID("id_application_view_module");
				window.DashboardView.SetObjectDOMName("window.DashboardView");
				
				window.DashboardView.Build(null, function(module) {
				});	
				
				window.StockAppend = new ModuleStockAppend();
				window.StockAppend.SetHostingID("id_application_view_module");
				window.StockAppend.SetObjectDOMName("window.StockAppend");
				market.Register("window.StockAppend", window.StockAppend.UpdateStockTableAsync, window.StockAppend);

				window.Portfolio = new ModulePortfolioView();
				window.Portfolio.SetHostingID("id_application_view_module");
				window.Portfolio.SetObjectDOMName("window.Portfolio");

				window.ImportActions = new ModuleImportActions();
				window.ImportActions.SetHostingID("id_application_view_module");
				window.ImportActions.SetObjectDOMName("window.ImportActions");

				ui = new NodeUI(node.API);
				market.Start();
				// User Code #1 - End
			}

			var UserEventRecieved = function(event, data) {
				console.log("OnNodeChangeEvent", event);
				// User Code #1 - Start
				switch(event) {
					case "upload_progress": {
						window.ImportActions.Uploader.UpdateProgress(data);
					}
					break;
					case "stock_info": {
						// window.DashboardView.BuildStockAsync(data);
						market.Publish(data);
					}
					break;
				}
				// User Code #1 - End
			}

			// Self-generated area
			[NODE_INSTANCE]
			// Self-generated area
			var ui 		= null;
			var market 	= new StockMarket();
		</script>
	</body>
</html>
