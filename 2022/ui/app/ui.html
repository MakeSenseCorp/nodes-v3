<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>TDD Executor</title>

		[CSS]

        <link rel="stylesheet" href="/static/lib/bootstrap/css/bootstrap.min.css" crossorigin="anonymous">
		<link rel="stylesheet" href="/static/lib/bootstrap/css/docs.min.css">
     
        <style>
            body {
              font-size: .875rem;
            }
            .feather {
              width: 16px;
              height: 16px;
              vertical-align: text-bottom;
            }
            html {
              position: relative;
              min-height: 100%;
            }
            body {
              /* Margin bottom by footer height */
              margin-bottom: 60px;
            }
            .footer {
              position: absolute;
              bottom: 0;
              width: 100%;
              /* Set the fixed height of the footer here */
              height: 60px;
              line-height: 60px; /* Vertically center the text there */
              background-color: #f5f5f5;
            }
            body > .container {
              padding: 60px 15px 0;
            }
            .footer > .container {
              padding-right: 15px;
              padding-left: 15px;
            }
            code {
              font-size: 80%;
            }
        </style>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
        <main role="main" class="container">
        	<div class="row">
				<div class="col-xl-1"></div>
				<div class="col-xl-10">
					<div class="bd-example">
						<div class="card">
							<div class="card-body">
								<div class="row text-center">
									<div class="col-xl-2">
										<a href="#" onclick="ui.OpenModalPortfolio();"><strong>Portfolios</strong></a>
									</div>
									<div class="col-xl-2">
										<a href="#" onclick="ui.OpenModalAppendNewStock();"><strong>Stocks</strong></a>
									</div>
									<div class="col-xl-2">
										<a href="#"><strong>Export</strong></a>
									</div>
									<div class="col-xl-2">
										<a href="#" onclick="ui.OpenModalImportStocks();"><strong>Import</strong></a>
									</div>
									<div class="col-xl-4">
										<a href="#"><strong>Settings</strong></a>
									</div>
								</div>
							</div>
						</div>
						<br>
						<div class="row">
							<div class="col-xl-12">
								<h5 class="mt-0"><strong>Choose Portfolio</strong></h5>
								<div class="card">
									<div class="card-body">
										<select class="custom-select d-block w-100" id="id_selected_portfolio" onchange="portfolioOnChangeHandler(this);" required>
											<option value='0'>Show All</option>
										</select>
									</div>
								</div>
							</div>
						</div>
						<br>
						<div class="row">
							<div class="col-xl-12">
								<h5 class="mt-0"><strong>Summary</strong></h5>
								<div class="card">
									<div class="card-body">
										<div class="row">
											<div class="col-xl-6">
												<div class="row text-center">
													<div class="col-xl-12">
														<div class="card mb-4 shadow-sm">
															<div class="card-header">
															  	<h6 class="my-0 fw-normal">Earnings Vs. Investment</h6>
															</div>
															<div class="card-body">
															  	<h4 class="card-title pricing-card-title"><span id="id_portfolio_earnings">0</span> (<strong class="text-muted" id="id_portfolio_investment">0</strong>)</h4>
															</div>
														</div>
													</div>
												</div>
											</div>
											<div class="col-xl-6">
												<div class="row text-center">
													<div class="col-xl-12">
														<div class="card mb-4 shadow-sm">
															<div class="card-header">
															  	<h6 class="my-0 fw-normal">Stocks Vs. Companes</h6>
															</div>
															<div class="card-body">
															  	<h4 class="card-title pricing-card-title"><strong class="text-muted" id="id_portfolio_number_of_stocks">0</strong> (<strong class="text-muted" id="id_portfolio_stocks_count"></strong>)</h4>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-xl-12">
								<div id="id_stocks_loading_progressbar"></div>
							</div>
						</div>
						<br>
						<div class="row">
							<div class="col-xl-12">
								<h5 class="mt-0"><strong>My Stocks</strong></h5>
								<div class="card">
									<div class="card-body">
										<div class="row" id="id_stocks_list">
											<div class="col-lg-4">
											</div>
											<div class="col-lg-1" style="text-align: right;">
												<span class="spinner-grow spinner-grow-lg" role="status" aria-hidden="true"></span>
											</div>
											<div class="col-lg-3" style="text-align:left;">
												<h4>Loading...</h4>
											</div>
											<div class="col-lg-4">
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-xl-1"></div>
			</div>
		</main>

		<script src="/static/lib/nodes/js/jquery_3_3_1/jquery.min.js"></script>
		<script src="/static/lib/nodes/js/popper_1_14_7/popper.min.js" crossorigin="anonymous"></script>
		<script src="/static/lib/bootstrap/js/bootstrap.min.js" crossorigin="anonymous"></script>
		<script src="/static/lib/bootstrap/js/bootstrap-slider.js" crossorigin="anonymous"></script>
		<script src="/static/lib/nodes/js/feather_4_19/feather.min.js"></script>
		<script src="/static/lib/nodes/map/feather_4_19/feather.min.js.map"></script>
		<script src="/static/lib/chartjs/current/Chart.min.js"></script>
		<script src="/mksdk-js/widgets/basic_modal.js"></script>
		<script src="/mksdk-js/widgets/basic_uploader.js"></script>
		<script src="/mksdk-js/widgets/basic_table.js"></script>
		<script src="/mksdk-js/widgets/progress_bar.js"></script>
		<script src="/mksdk-js/widgets/block_table.js"></script>
		<script src="/mksdk-js/widgets/basic_graph.js"></script>
        
        [SCRIPTS]

        <script>
			/*
			[GATEWAY]
			[NODE_UUID]
			[CUSTOM_VARS]
			*/

			[CONFIGURATION]

			require ModuleStocksAdaptor
			require ModuleStockLine
			require ModuleStockInfo
			require ModuleRowStock
			require ModuleStockHistoryGraph
			require ModuleStockDetails
			require ModulePortfolio
			require ModuleAction
			require ModuleStockAppend
			require ModuleImportActions

			console.log("Gateway IP address - " + GatewayIP);

			var g_portfolio_id 	 = 0;
			var g_portfolio_name = "";
			
			// User Code #1 - Start
			var portfolioOnChangeHandler = function(obj) {
				g_portfolio_id   = obj.value;
				g_portfolio_name = obj.options[obj.value].text;
				node.API.SendCustomCommand(NodeUUID, "get_portfolio_stocks", {
					"portfolio_id": parseInt(obj.value),
					"portfolio_name": g_portfolio_name
				}, function(res) {
					var payload = res.data.payload;
					ui.RebuildPortfolioEarnings(payload.portfolio);
					ui.RebuildStockTable(payload.stocks);
				});
			};
			// User Code #1 - End

			$(document).ready(function() {
				// User Code #1 - Start
				
				// User Code #1 - End
			});		

			function NodeUI(api) {
				this.API = api;
				
				this.Uploader = MksBasicUploaderBuilder.GetInstance();
				this.Uploader.SetAPI(this.API);
				this.Uploader.SetFileType(["ms-excel","csv"])
				this.Uploader.OnUploadCompete = window.ImportActions.OnUploadCompleteHandler;

				this.StockLoaderProgressBar	= new MksBasicProgressBar("StockLoaderProgressBar");
				this.StockLoaderProgressBar.EnableInnerPercentageText(false);
				this.StockLoaderProgressBar.Build(document.getElementById("id_stocks_loading_progressbar"));
				this.StockLoaderProgressBar.Show();

				window.Modal = new MksBasicModal();
				this.objStockTable = document.getElementById("id_stocks_list");
				this.objPortfolioEarnings = document.getElementById("id_portfolio_earnings");
				this.objPortfolioStocksNumber = document.getElementById("id_portfolio_number_of_stocks");
				this.objPortfolioInvestment = document.getElementById("id_portfolio_investment");
				this.objPortfolioStocksCount = document.getElementById("id_portfolio_stocks_count");

				this.ConfirmFooter = `
					<button type="button" class="btn [COLOR]" onclick="[FUNC]">[NAME]</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
				`;

				return this;
			}

			NodeUI.prototype.OpenModalImportStocks = function() {
				var self = this;

				window.ImportActions.SetObjectDOMName("window.ImportActions");
				window.ImportActions.SetHostingID("module_stock_append");
				window.ImportActions.Build(null, function(module){
					window.Modal.Remove();
					window.Modal.SetTitle("Append New Stock");
					window.Modal.SetContent(window.ImportActions.HTML);
					window.Modal.SetFooter(`
						<button type="button" class="btn btn-success" onclick="window.ImportActions.ImportStocks();">Import</button>
						<button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
					`);
					window.Modal.Build("lg");
					window.Modal.Show();

					var objUploader = document.getElementById("id-basic-uploader-installer");
					// Build DOM UI for Uploader
					self.Uploader.Build(objUploader, "Upload");
				});
			}

			NodeUI.prototype.OpenModalPortfolio = function() {
				var self = this;
				window.Portfolio.SetHostingID("portfolio_modal");
				window.Portfolio.SetObjectDOMName("window.Portfolio");
				window.Portfolio.Build(null, function(module) {
					window.Modal.Remove();
					window.Modal.SetTitle("Create portfolio");
					window.Modal.SetContent(module.HTML);
					window.Modal.SetFooter(`
						<button type="button" class="btn btn-success" onclick="window.Portfolio.CreatePortfolio();">Create</button>
						<button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
					`);
					window.Modal.Build("sm");
					window.Modal.Show();
				});
			}

			NodeUI.prototype.OpenModalAction = function(ticker, action) {
				var self = this;

				window.Action = new ModuleAction();
				window.Action.SetObjectDOMName("window.Action");
				window.Action.SetHostingID("module_action");
				window.Action.Build({
					"ticker": ticker,
					"action": action
				}, null);

				var footer = `
					<button type="button" class="btn [COLOR]" onclick="[FUNC]">[NAME]</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
				`;
				footer = footer.split("[NAME]").join(action);
				if (action == "SELL") {
					footer = footer.split("[COLOR]").join("btn-success");
					footer = footer.split("[FUNC]").join("window.Action.AppendStockAction('"+ticker+"',1);");
				} else {
					footer = footer.split("[COLOR]").join("btn-danger");
					footer = footer.split("[FUNC]").join("window.Action.AppendStockAction('"+ticker+"',-1);");
				}

				window.Modal.Remove();
				window.Modal.SetTitle(action);
				window.Modal.SetContent(window.Action.HTML);
				window.Modal.SetFooter(footer);
				window.Modal.Build("lg");
				window.Modal.Show();
			}

			NodeUI.prototype.OpenModalAppendNewStock = function() {
				var self = this;

				window.StockAppend = new ModuleStockAppend();
				window.StockAppend.SetObjectDOMName("window.StockAppend");
				window.StockAppend.SetHostingID("module_stock_append");
				window.StockAppend.Build(null, function(module){
					window.Modal.Remove();
					window.Modal.SetTitle("Append New Stock");
					window.Modal.SetContent(window.StockAppend.HTML);
					window.Modal.SetFooter(`
						<button type="button" class="btn btn-primary" onclick="">Confirm</button>
						<button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
					`);
					window.Modal.Build("lg");
					window.Modal.Show();
					window.StockAppend.GetDataBaseStocks();
				});
			}

			NodeUI.prototype.OpenModalStockDetails = function(ticker) {
				var self = this;

				window.StockDetails = new ModuleStockDetails();
				window.StockDetails.SetHostingID("details_modal");
				window.StockDetails.SetObjectDOMName("window.StockDetails");
				window.StockDetails.Build(null, function(module) {
					window.Modal.Remove();
					window.Modal.SetTitle("Details");
					window.Modal.SetContent(module.HTML);
					window.Modal.SetFooter(`<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>`);
					window.Modal.Build("lg");
					window.Modal.Show();
					module.GetDetails(ticker);
				});
			}

			NodeUI.prototype.RebuildPortfolioEarnings = function(portfolio) {
				this.objPortfolioInvestment.innerHTML = portfolio.investment;
				this.objPortfolioStocksCount.innerHTML = portfolio.stocks_count;
				this.objPortfolioEarnings.innerHTML = portfolio.earnings;
				if (portfolio.earnings < 0) {
					this.objPortfolioEarnings.style.color = "RED";
				} else {
					this.objPortfolioEarnings.style.color = "GREEN";
				}
			}

			NodeUI.prototype.UpdateStocksPrice = function() {
				self = this;
				node.API.SendCustomCommand(NodeUUID, "get_portfolio_stocks", {
					"portfolio_id": parseInt(g_portfolio_id),
					"portfolio_name": g_portfolio_name
				}, function(res) {
					var payload = res.data.payload;
					var portfolio = payload.portfolio;

					for (key in payload.stocks) {
						var stock = payload.stocks[key];
						var obj = document.getElementById("id_stock_table_price_" + stock.ticker);
						obj.innerHTML = stock.market_price;
						obj = document.getElementById("id_stock_table_earnings_" + stock.ticker);
						obj.innerHTML = "(" + stock.earnings + ")";
					}
					
					ui.objPortfolioEarnings.innerHTML = portfolio.earnings;
					if (portfolio.earnings < 0) {
						ui.objPortfolioEarnings.style.color = "RED";
					} else {
						ui.objPortfolioEarnings.style.color = "GREEN";
					}
				});
			}

			NodeUI.prototype.RebuildStockTable = function(stocks) {
				var tableContent = "";
				var portfolioStocksCount = 0.0;

				var ui_size = "lg";
				if (stocks.length > 30) {
					ui_size = "sm";
				}

				var row = new ModuleRowStock();
				for (key in stocks) {
					var stock 	  = stocks[key];
					stock.ui_size = ui_size;
					tableContent += row.Build(stock);
					portfolioStocksCount += stock.number;
				}
				
				this.objStockTable.innerHTML = tableContent;
				this.objPortfolioStocksNumber.innerHTML = portfolioStocksCount;
				$('[data-toggle="tooltip"]').tooltip();
			}

			NodeUI.prototype.GetStocks = function() {
				var self = this;
				node.API.SendCustomCommand(NodeUUID, "get_portfolio_stocks", {
					"portfolio_id": 0,
					"portfolio_name": "All"
				}, function(res) {
					var payload = res.data.payload;
					if (payload.status.local_stock_market_ready == false) {
						ui.StockLoaderProgressBar.UpdateProgress({
							'precentage': payload.status.percentage,
							'message': "Loading (" + payload.status.percentage + "%)"
						});
						setTimeout(ui.GetStocks, 2500);
						return;
					}

					ui.StockLoaderProgressBar.Hide();
					ui.RebuildPortfolioEarnings(payload.portfolio);
					ui.RebuildStockTable(payload.stocks);
					node.GetStocksTimerHndl = setInterval(ui.UpdateStocksPrice, 10000);
				});
			}

			var UserInit = function() {
				// User Code #1 - Start

				// User Code #1 - End
			}

			var UserPostInit = function() {
				// User Code #1 - Start

				// User Code #1 - End
			}

			var UserNodeLoaded = function() {
				// User Code #1 - Start
				window.Portfolio 		= new ModulePortfolio();
				window.ImportActions 	= new ModuleImportActions();
				
				this.GetStocksTimerHndl = null;
				ui = new NodeUI(node.API);
				window.Portfolio.UpdatePortfolioList("id_selected_portfolio");
				ui.GetStocks();
				// User Code #1 - End
			}

			var UserEventRecieved = function(event, data) {
				// console.log("OnNodeChangeEvent", packet, packet.data.payload.event);
				// User Code #1 - Start
				switch(event) {
					case "upload_progress": {
						ui.Uploader.UpdateProgress(data);
					}
				}
				// User Code #1 - End
			}

			// Self-generated area
			[NODE_INSTANCE]
			// Self-generated area
			var ui = null;
		</script>
	</body>
</html>
